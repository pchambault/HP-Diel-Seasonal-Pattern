---
title: "Dive Clustering and Bouts"
author: "Philippine Chambault"
date: "2023-01-19"
output:
  bookdown::html_document2:
    number_sections: yes
    code_folding: show
    df_print: default
    fig_caption: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo      = TRUE,
  fig.align = "center",
  message = FALSE,
  warning = FALSE,
  out.width = "100%"
)
```

__Background__:
Dive clustering to identify dive types and investigation of dive sequences (bouts). Analysis on the high resolution dataset (n=5). Clustering analysis based on k=4 clusters.

```{r, global_options, include=FALSE}
library(ggplot2)
library(tidyquant)
library(gridExtra)
library(tidyverse)
library(viridis)
library(DT)
library(data.table)
library(ggcorrplot)
```


# Clustering analysis
```{r, echo=F}
clust <- readRDS("./RDATA/4.Clustering/4.DiveCluster_5HP_4clusters.RDS")
table(clust$cluster)

clust %>%
  group_by(cluster) %>%
  summarise(maxdep    = mean(maxdep),            # in m
            meandep   = mean(meandep),           # in m
            dur       = mean(dur)/60,            # in min
            desc_rate = mean(des_rate, na.rm=T), # in m/s
            asc_rate  = mean(asc_rate, na.rm=T), # in m/s
            bot_dur   = mean(bot_dur, na.rm=T))  # in sec

clust$month = factor(clust$month, 
                     levels = c("Jul","Aug","Sep",
                                "Oct","Nov","Dec","Jan"))

# import locations for the 5 HP
#----------------------------------
setwd("/Users/philippinechambault/Documents/POST-DOC/2021/MSCA-GF/ANALYSES/HP-Diel-Seasonal-Pattern")
loc <- readRDS("./RDATA/1a.locations_filtered_17HP.rds") %>% 
  dplyr::select(id, posix_local, bathy_200, lon, lat)  %>%
  filter(id == "27262" | id == "22849b" | id == "22850b" | 
           id == "27262b" | id == "93100") %>%
  rename(date = posix_local, bathy = bathy_200)
clust = clust %>% rename(date = start)

# convert into data tables
#-------------------------
diveDT = setDT(clust)
setkey(diveDT,id,date)
locDT  = setDT(loc)
setkey(locDT,id,date)

# rolling join on date
clust2 = locDT[,.(date, id, lon, lat, bathy)] %>%
  .[diveDT, roll="nearest"] %>%
  .[] # to display tibble
clust2 -> clust
rm(clust2)
clust = as_tibble(clust)
clust = clust %>% rename(start = date) 
```

<span style="color: #D01C8B;">Type 1</span>: moderate dives (<50 m) with the longest bottom duration (close to 1 min, U-shape?) and fastest descent and ascent rates.

<span style="color: #F1B6DA;">Type 2</span>: moderate dives (60 m, 2 min).

<span style="color: #B8E186;">Type 3</span>: deepest and longest dives with short vertical speed and moderate bottom duration (V-shape?).

<span style="color: #4DAC26;">Type 4</span>: shallow ans short dives (<30 m and ~1 min).


The 4 clusters have been selected arbitrary because the R package _factominR_ does not work with large datasets like this one, so I could not use an alternative package or function to identify the optimal number of clusters needed, but 4 seems realistic and large enough to capture to different dive types.









# Cluster proportions {.tabset}
## All (position=fill)
```{r, echo=F}
dat = clust %>%
  group_by(month) %>%
  mutate(index = seq(1, length.out = n(), by = 1)) %>%
  summarise(ntot = n(),
            cluster1 = n_distinct(index[cluster == "1"]),
            cluster2 = n_distinct(index[cluster == "2"]),
            cluster3 = n_distinct(index[cluster == "3"]),
            cluster4 = n_distinct(index[cluster == "4"]),) %>%
  ungroup()

prop = dat %>%
  mutate(type1 = (cluster1 / ntot) * 100,
         type2 = (cluster2 / ntot) * 100,
         type3 = (cluster3 / ntot) * 100,
         type4 = (cluster4 / ntot) * 100)

pivot = prop %>%
  pivot_longer(c(type1, type2, type3, type4), 
               names_to = "cluster", values_to = "prop") %>%
  select(month,ntot,cluster,prop) 
pivot$cluster = factor(pivot$cluster,
                       levels=c("type1","type2","type3","type4"))
pivot$month = factor(pivot$month, 
                     levels = c("Jul","Aug","Sep",
                                "Oct","Nov","Dec","Jan"))

pivot$cluster = factor(pivot$cluster, 
                       levels = c("type4","type2","type1","type3"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap=" Histograms of dive frequency across months and dive type."}
ggplot(pivot, aes(y=prop, x=month)) +
  geom_histogram(aes(fill=cluster), stat="identity",
                 position="fill") +
  scale_fill_brewer(palette = "PiYG") +
  labs(x = "", y = "Dive frequency (%)",fill = "") +
  theme_tq() +
  theme(panel.grid.major = element_blank())
```
Type 4 and 1 (shallow and short dives) are becoming less and less frequent when approaching winter, while long and deep dives (Type 2 and 3) become more frequent over months.

## All (position=dodge)
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap=" Histograms of dive frequency across months and dive type."}
ggplot(pivot, aes(y=prop, x=month)) +
  geom_histogram(aes(fill=cluster), stat="identity",
                 position="dodge") +
  scale_fill_brewer(palette = "PiYG") +
  labs(x = "", y = "Dive frequency (%)",fill = "") +
  theme_tq() +
  theme(panel.grid.major = element_blank())
```
Easier to see the trends with the argument _"position=dodge"_.


## Per ID (position=fill)
```{r, echo=F}
dat = clust %>%
  group_by(id, month) %>%
  mutate(index = seq(1, length.out = n(), by = 1)) %>%
  summarise(ntot = n(),
            cluster1 = n_distinct(index[cluster == "1"]),
            cluster2 = n_distinct(index[cluster == "2"]),
            cluster3 = n_distinct(index[cluster == "3"]),
            cluster4 = n_distinct(index[cluster == "4"]),) %>%
  ungroup()

prop = dat %>%
  mutate(type1 = (cluster1 / ntot) * 100,
         type2 = (cluster2 / ntot) * 100,
         type3 = (cluster3 / ntot) * 100,
         type4 = (cluster4 / ntot) * 100)

pivot = prop %>%
  pivot_longer(c(type1, type2, type3, type4), 
               names_to = "cluster", values_to = "prop") %>%
  select(id,month,ntot,cluster,prop) 
pivot$cluster = factor(pivot$cluster,
                       levels=c("type1","type2","type3","type4"))
pivot$month = factor(pivot$month, 
                     levels = c("Jul","Aug","Sep",
                                "Oct","Nov","Dec","Jan"))
pivot$cluster = factor(pivot$cluster, 
                       levels = c("type4","type2","type1","type3"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=3.5, fig.cap="Indiviual histograms of dive frequency across months and dive type."}
ggplot(pivot, aes(y=prop, x=month)) +
  geom_histogram(aes(fill=cluster), stat="identity",
                 position="fill") +
  facet_wrap(~id, ncol = 5) +
  scale_fill_brewer(palette = "PiYG") +
  labs(x = "", y = "Dive frequency (%)",fill = "") +
  theme_tq() +
  theme(panel.grid.major = element_blank(),
        axis.text.x = element_text(angle = 90))
```
Similar trend across individuals.

## Per id (position=dodge)
```{r, echo=FALSE, fig.pos="placeHere", fig.height=3.5, fig.cap="Indiviual histograms of dive frequency across months and dive type."}
ggplot(pivot, aes(y=prop, x=month)) +
  geom_histogram(aes(fill=cluster), stat="identity",
                 position="dodge") +
  facet_wrap(~id, ncol = 5) +
  scale_fill_brewer(palette = "PiYG") +
  # scale_fill_manual(values = c("lightsalmon","navajowhite1",
  #                              "#337882","dodgerblue3")) +
  labs(x = "", y = "Dive frequency (%)",fill = "") +
  theme_tq() +
  theme(panel.grid.major = element_blank(),
        axis.text.x = element_text(angle = 90))
```




# Dive clusters {.tabset}
## Cluster visualization
```{r pressure, echo=FALSE, fig.cap="Clusters identified using K mean", out.width = '80%'}
knitr::include_graphics("./FIGURES/Clustering/Dive_clusters_k4.png")
```
4 clusters seems realistic, but 3 might be enough.

## Max depth
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the maximum depth according to the dive clusters. Red dots are the means."}
ggplot(clust, aes(x=cluster, y=-maxdep, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(m)",title="Mean max depth") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  ylim(-365,0) +
  theme(legend.position = "none")
```

## Mean depth
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the mean depth according to the dive clusters."}
ggplot(clust, aes(x=cluster, y=-meandep, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(m)",title="Mean depth") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  theme(legend.position = "none")
```

## Duration
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the dive duration according to the dive clusters."}
ggplot(clust, aes(x=cluster, y=dur/60, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(min)", title="Dive duration") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  ylim(0, 6) +
  theme(legend.position = "none")
```

## Descent rate
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the descent rate according to the dive clusters."}
ggplot(clust, aes(x=cluster, y=des_rate, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(m/s)", title="Descent rate") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  ylim(0, 1.7) +
  theme(legend.position = "none")
```

## Ascent rate
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the ascent rate according to the dive clusters."}
ggplot(clust, aes(x=cluster, y=asc_rate, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) +
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(m/s)", title="Ascent rate") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  ylim(0, 2) +
  theme(legend.position = "none")
```

## Bottom duration
```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Boxplot of the bottom duration according to the dive clusters."}
ggplot(clust, aes(x=cluster, y=bot_dur, fill=cluster)) +
  geom_boxplot(outlier.shape = NA) + 
  stat_summary(fun.y="mean", colour="red", size=0.2) +
  labs(x="Clusters", y="(sec)", title="Bottom duration") +
  scale_fill_brewer(palette = "PiYG") +
  theme_tq()  +
  ylim(0,120) +
  theme(legend.position = "none")
```










# Dive profiles according to dive type {.tabset}
## ID 93100
```{r, echo = F}
i  = "93100"
id = clust %>% filter(id == i) 
id$month = factor(id$month, 
                  levels = c("Jul","Aug","Sep",
                             "Oct","Nov","Dec","Jan"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=8, fig.cap="Dive profile of individual 93100 over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.1) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                   date_labels = "%d", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  facet_wrap(~month, ncol=1, scales="free_x") +
  labs(y = "Maximum depth (m)", x = "Day of the month", 
       colour="Dive type",
       title=paste0(unique(id$id))) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```


## ID 22849b
```{r, echo = F}
i  = "22849b"
id = clust %>% filter(id == i) 
id$month = factor(id$month, 
                  levels = c("Jul","Aug","Sep",
                             "Oct","Nov","Dec","Jan"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=8, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.1) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                   date_labels = "%d", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  # scale_colour_manual(values = c("lightsalmon","navajowhite1",
  #                                "#337882","dodgerblue3")) +
  theme_tq() +
  facet_wrap(~month, ncol=1, scales="free_x") +
  labs(y = "Maximum depth (m)", x = "Day of the month", 
       colour="Dive type",
       title=paste0(unique(id$id))) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```



## ID 22850b
```{r, echo = F}
i  = "22850b"
id = clust %>% filter(id == i) 
id$month = factor(id$month, 
                  levels = c("Jul","Aug","Sep",
                             "Oct","Nov","Dec","Jan"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=8, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.1) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                   date_labels = "%d", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  # scale_colour_manual(values = c("lightsalmon","navajowhite1",
  #                                "#337882","dodgerblue3")) +
  theme_tq() +
  facet_wrap(~month, ncol=1, scales="free_x") +
  labs(y = "Maximum depth (m)", x = "Day of the month", 
       colour="Dive type",
       title=paste0(unique(id$id))) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```

## ID 27262
```{r, echo = F}
i  = "27262"
id = clust %>% filter(id == i) 
id$month = factor(id$month, 
                  levels = c("Jul","Aug","Sep",
                             "Oct","Nov","Dec","Jan"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=8, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.1) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                   date_labels = "%d", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  # scale_colour_manual(values = c("lightsalmon","navajowhite1",
  #                                "#337882","dodgerblue3")) +
  theme_tq() +
  facet_wrap(~month, ncol=1, scales="free_x") +
  labs(y = "Maximum depth (m)", x = "Day of the month", 
       colour="Dive type",
       title=paste0(unique(id$id))) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```

## ID 27262b
```{r, echo = F}
i  = "27262b"
id = clust %>% filter(id == i) 
id$month = factor(id$month, 
                  levels = c("Jul","Aug","Sep",
                             "Oct","Nov","Dec","Jan"))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=8, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.1) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 day"), 
                   date_labels = "%d", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  # scale_colour_manual(values = c("lightsalmon","navajowhite1",
  #                                "#337882","dodgerblue3")) +
  theme_tq() +
  facet_wrap(~month, ncol=1, scales="free_x") +
  labs(y = "Maximum depth (m)", x = "Day of the month", 
       colour="Dive type",
       title=paste0(unique(id$id))) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```










# Zoom in dive profiles {.tabset}
## ID 93100: 30 Jul
```{r, echo = F}
i  = "93100"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Jul" & day == 30) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 93100 over time and according to dive type. Grey and beige shades refer to night and day, respectively."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  scale_colour_brewer(palette = "PiYG") +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 30 Jul")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```

## ID 93100: 4 Oct
```{r, echo = F}
i  = "93100"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Oct" & day == 4) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 93100 over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 4 Oct")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```



## ID 93100: 3 Jan
```{r, echo = F}
i  = "93100"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Jan" & day == 3) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 93100 over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 3 Jan")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```





## ID 22849b: 26 Jul
```{r, echo = F}
i  = "22849b"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Jul" & day == 26) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 26 Jul")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3) ) )
```






## ID 22849b: 11 Sep
```{r, echo = F}
i  = "22849b"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Sep" & day == 11) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 11 Sep")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3)))
```




## ID 22849b: 5 Dec
```{r, echo = F}
i  = "22849b"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Dec" & day == 5) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 22849b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day",
       colour="Dive type",
       title=paste0(unique(id$id),": 5 Dec")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3)))
```





## ID 27262b: 4 Dec
```{r, echo = F}
i  = "27262b"
id = clust %>% 
  mutate(day = as.numeric(format(start, "%d"))) %>%
  filter(id == i & month == "Dec" & day == 5) 
rect = data.frame(x1=first(id$start[id$day_phase=="day"]),
                  x2=last(id$start[id$day_phase=="day"]))
```

```{r, echo=FALSE, fig.pos="placeHere", fig.height=4, fig.cap="Dive profile of individual 27262b over time and according to dive type."}
ggplot(id, aes(y=maxdep, x=start)) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x1, ymin = -Inf,
                xmax = x2, ymax = Inf),
            fill = "navajowhite2", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = first(id$start),ymin = -Inf,
                xmax = x1, ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_rect(data = rect, alpha = 0.6,
            aes(xmin = x2, ymin = -Inf,
                xmax = last(id$start), ymax = Inf),
            fill = "#595b54", inherit.aes = F) +
  geom_linerange(aes(ymin = 0, ymax = maxdep, colour=cluster),
                 linewidth=0.5) +
  scale_y_continuous(trans = "reverse", expand=c(0,0), 
                     limits=c(365,0),
                     breaks=c(50,100,200,300)) +
  scale_x_datetime(breaks = scales::date_breaks("1 hour"), 
                   date_labels = "%H:%M", expand=c(0,0)) +
  scale_colour_brewer(palette = "PiYG") +
  geom_line(data=id, aes(x=start, y=bathy),colour="red",lwd=0.3) +
  theme_tq() +
  labs(y = "Maximum depth (m)", x = "Hour of the day", 
       colour="Dive type",
       title=paste0(unique(id$id),": 5 Dec")) +
  theme(legend.position = "bottom",
        legend.key.size = unit(0.8, 'cm'),     #change legend key size
        legend.key.height = unit(0.3, 'cm'),   #change legend key height
        legend.key.width = unit(0.3, 'cm'),    #change legend key width
        legend.text = element_text(size=8),    #change legend text font size
        legend.background = element_blank(),
        legend.key = element_blank(),
        axis.text.x = element_text(size=6, vjust = 0.5, hjust=0.5),
        axis.text.y  = element_text(size=5, hjust=0.5),
        title = element_text(colour="black",size=10,face="bold"),
        plot.title=element_text(size=10, vjust=0, hjust=0, # t r b l
                                colour="black"),
        strip.text = element_text(size=7, colour = "white",
                                  margin = margin(0.5,0.5,0.5,0.5, "mm")),
        strip.background = element_rect(fill = "steelblue4",
                                        colour="white"),
        plot.margin = unit(c(0.2,0.2,0.2,0.1), "cm"),
        panel.border = element_rect(size = 0.2),
        panel.spacing.x = unit(0.0, "lines"),
        panel.spacing.y = unit(0.1, "lines"),
        panel.grid.minor = element_blank()) +
  guides(color = guide_legend(override.aes = list(linewidth = 3)))
```